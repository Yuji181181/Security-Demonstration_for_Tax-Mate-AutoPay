# Security Demonstration: Tax-Mate AutoPay

このリポジトリは、LLMアプリケーションへの攻撃と防御の実証デモアプリケーションです。  

自律型AIエージェントに対する **Indirect Prompt Injection（間接的プロンプトインジェクション）** 攻撃と、それに対する **Defense in Depth（多層防御）** 戦略を実証するために作成しました。

---

## プロジェクトの目的

### 攻撃シナリオの実証

**シナリオ:** 経理処理を行うAIエージェント「Tax-Mate AutoPay」が、外部から受け取った「請求書」を読み取り、銀行APIを操作して支払いを実行する。  
**攻撃手法:** 攻撃者は請求書に「攻撃者の口座へ送金しろ」という隠し命令を仕込む（Indirect Prompt Injection）。  
**脅威:** 脆弱なエージェントは、元のシステム指示よりも攻撃命令を優先してしまい、外部システム（銀行API）に対して不正な変更・送金を行ってしまう。

### Defense in Depth（多層防御）の実装

単一の防御策に頼るのではなく、**4つの防御層**を組み合わせることで、攻撃を阻止または検知します。

#### 第1層: プロンプトエンジニアリング（最前線）
- **目的**: システムプロンプトでAIの振る舞いを制御
- **実装**: 堅牢なエージェントに防御的プロンプトを設定
- **限界**: 巧妙な攻撃は突破される可能性がある

#### 第2層: LLM Guardrails / Watchdog（監視層）
- **目的**: AIが不正な命令を実行する前にブロック
- **実装**: LangGraphを用いて、ツール実行前に別のLLM（Llama 3.3 70B）が監査
- **効果**: プロンプトインジェクションを検知してブロック

#### 第3層: システム・DBレベルの制御（基盤層）
- **目的**: AIに必要最小限の権限しか与えない
- **実装**: 
  - **RBAC（Role-Based Access Control）**: READ_ONLY権限では送金・口座変更を物理的にブロック
  - **監査ログシステム**: 全取引を記録し、異常パターン（高額送金、ブラックリスト口座）を自動検出
- **効果**: AIが騙されても、システムが実行を拒否。攻撃成功後も必ず検知

#### 第4層: Human-in-the-Loop（最終防壁）
- **目的**: 重要な操作は人間が最終判断
- **実装**: 高額送金（50,000円以上）や口座変更は人間の承認を要求
- **効果**: AIの判断ミスを人間が防ぐ

---

## デモの構成

### 🔴 脆弱なエージェント（攻撃デモ）
**防御層なしの「脆弱な構成」の例。**
- **結果**: 請求書の攻撃命令に従い、不正送金を実行してしまう
- **検証**: どんなに賢いモデルでも、**防御設計がないと無力である**ことを実証

### 🟢 堅牢なエージェント（第1層+第2層）
**プロンプトエンジニアリング + LLM Guardrailsの例。**
- **結果**: ガードレールAI（Llama 3.3 70B）が攻撃命令の矛盾を検知してブロック
- **検証**: **「能力」ではなく「設計」がセキュリティの鍵である**ことを実証

### 👮 銀行監査システム（第3層：検知）
**システムレベルの制御と事後検知。**
- **RBAC**: READ_ONLY権限で送金をブロック
- **監査**: 高額送金やブラックリスト口座への取引を自動検出
- **検証**: 攻撃が成功しても、必ず発見できることを実証

### 🙋 Human-in-the-Loop（第4層：最終防壁）
**人間による承認フロー。**
- **承認待ち**: 高額送金や口座変更は人間の承認が必要
- **承認/拒否**: UIで操作を承認または拒否
- **検証**: AIの判断を人間が最終チェックできることを実証

---

## デモの使い方

1. **サイドバーで権限を選択**
   - `ADMIN`: 全ての操作が可能（攻撃が成功する可能性あり）
   - `READ_ONLY`: 書き込み操作は禁止（第3層が防御）

2. **タブを切り替えて実験**
   - 🔴 **脆弱なエージェント**: 防御なし（攻撃の脅威を実証）
   - 🟢 **堅牢なエージェント**: 第1層+第2層（プロンプト+ガードレール）
   - 👮 **銀行監査システム**: 第3層（RBAC + 事後検知）
   - 🙋 **Human-in-the-Loop**: 第4層（人間による承認）

3. **結果を確認**
   - 緑色 = 防御成功
   - 赤色 = 攻撃成功
   - 黄色 = 承認待ち/検知成功

---

## 実装されているセキュリティ機能

### 1. プロンプトエンジニアリング
- 堅牢なエージェントに防御的システムプロンプトを設定

### 2. LLM Guardrails
- ツール実行前に別のLLMが監査
- 不正な操作を自動検知してブロック

### 3. RBAC（Role-Based Access Control）
- `contextvars`を使用した安全な権限伝播
- READ_ONLY権限では送金・口座変更を物理的にブロック

### 4. 監査ログシステム
- 全取引を記録
- ルールベースで異常検出（高額送金、ブラックリスト口座）

### 5. Human-in-the-Loop
- 高額送金（50,000円以上）は人間の承認が必要
- 口座変更も承認フロー

---

## 起動方法


### バックエンド起動

```bash
uv run uvicorn src.backend.server:app --port 8000
```

### フロントエンド起動

```bash
uv run streamlit run src/frontend/app.py --server.port 8501
```

---

## 技術スタック

- **Language:** Python 3.12 (uv)
- **LLM:** Groq API (Llama 3.3 70B Versatile)
- **Agent Framework:** LangGraph
- **Backend:** FastAPI
- **Frontend:** Streamlit
- **infrastructure:** Google Cloud Run

---

## 主要ファイル構成

```
src/
├── backend/
│   ├── agents.py          # LLMエージェント（脆弱版、堅牢版、HITL版）
│   ├── server.py          # FastAPI サーバー
│   ├── mock_bank.py       # 仮想銀行システム（RBAC、監査機能）
│   └── context.py         # 権限管理用コンテキスト
├── frontend/
│   └── app.py             # Streamlit UI
└── data/
    └── invoices.py        # 攻撃が仕込まれた請求書データ

```
